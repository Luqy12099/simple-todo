{% extends 'register/base.html'%}

{% block tittle %}
Update To DO
{% endblock %}

{% load crispy_forms_tags %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-8">
                <form id="editForm" method="post" action="{% url 'todolist_update' todo_id=todo.id %}">
                    {% csrf_token %}
                    <input type="text" name="name" id="editInput" value="{{ todo.name }}" readonly>
                    <button type="button" id="editButton">Edit</button>
                    <button type="submit" id="saveButton" style="display: none;">Save</button>
                </form>
            </div><!-- /.col -->
        </div><!-- /.row -->
    </div><!-- /.container-fluid -->
</div>

<div class="container-fluid">
    <div class="row">
        <!-- Left Column -->
        <div class="col-md-6">
            <h2>Left Column</h2>
            <p>This is the content of the left column.</p>
            <form id="createItemForm" method="post" action="{% url 'item_create' %}">
                {% csrf_token %}
                <input type="hidden" name="todo_id" value="{{ todo.id }}">
                <input type="text" name="text" placeholder="New Item" required>
                <button type="submit">Add Item</button>
            </form>
        </div>

        <!-- Right Column -->
        <div class="col-md-6">
            <h2>Right Column</h2>
            <p>This is the content of the right column.</p>
            <form method="post" id="updateForm">
                <div class="input-grid">
                    <div class="all-items">
                    <div class="incomplete-items">
                        {% for item in items %}
                            {% if not item.complete %}
                                <div class="input-group-text">
                                    <input class="form-check-input mt-0 item-checkbox" type="checkbox" value="clicked" aria-label="Checkbox for item" 
                                        {% if item.complete %}checked{% endif %} data-item-id="{{ item.id }}">
                                    <p class="{% if item.complete %}completed-item{% endif %}">{{ item.text }}</p>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <div class="complete-items">
                        {% for item in items %}
                            {% if item.complete %}
                                <div class="input-group-text">
                                    <input class="form-check-input mt-0 item-checkbox" type="checkbox" value="clicked" aria-label="Checkbox for item" 
                                        {% if item.complete %}checked{% endif %} data-item-id="{{ item.id }}">
                                    <p class="{% if item.complete %}completed-item{% endif %}">{{ item.text }}</p>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    </div>
                </div>
            </form>

        </div>
    </div><!-- /.row -->
</div>

<script>
    document.getElementById('editButton').addEventListener('click', function () {
        document.getElementById('editInput').readOnly = false;
        document.getElementById('editInput').focus();

        document.getElementById('editButton').style.display = 'none';
        document.getElementById('saveButton').style.display = 'inline-block';
    });
</script>


<script>
    // This code to handle checkedbox, to async with page
    // Async with API, so didnt need to reload the page

    $(document).ready(function () {
        // Function to get the CSRF token from the cookie
        function getCSRFToken() {
            var csrfToken = null;
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.startsWith('csrftoken=')) {
                    csrfToken = cookie.substring('csrftoken='.length, cookie.length);
                    break;
                }
            } 
            return csrfToken;
        }

        $('.item-checkbox').on('change', function () {
            var itemId = $(this).data('item-id');
            var isChecked = $(this).prop('checked');

            // Get the CSRF token
            var csrfToken = getCSRFToken();

            // Make an asynchronous request to update the item's completion status
            $.ajax({
                url: '{% url "item_update" %}',  // Replace with your URL for updating item status
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken  // Include the CSRF token in the headers
                },
                data: {
                    'item_id': itemId,
                    'is_checked': isChecked
                },
                success: function (data) {
                    // Handle success if needed
                },
                error: function (error) {
                    // Handle error if needed
                }
            });
        });
    });
</script>

<script>
    // This code to handle line-through
    // So everytime item checked, it mean complete, and it will have line through the item

    // Attach the toggleCompleted class function to the change event of checkboxes
    var checkboxes = document.querySelectorAll('.item-checkbox');
    checkboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            var itemText = checkbox.parentNode.querySelector('p');
            itemText.classList.toggle('completed-item', checkbox.checked);
        });
    });
</script>

<script>
    // This code to handle reodering
    // So everytime item checked, it mean complete, and it will on the bottom of the list

    function reorderItems() {
        var incompleteItemsContainer = document.querySelector('.incomplete-items');
        var completeItemsContainer = document.querySelector('.complete-items');
        var checkboxes = document.querySelectorAll('.item-checkbox');

        checkboxes.forEach(function(checkbox) {
            var itemText = checkbox.parentNode.querySelector('p');
            var parentContainer = checkbox.checked ? completeItemsContainer : incompleteItemsContainer;
            parentContainer.appendChild(checkbox.parentNode);
        });
    }

    var checkboxes = document.querySelectorAll('.item-checkbox');
    checkboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', reorderItems);
    });
</script>

<style>
    .input-grid {
        display: grid;
        grid-template-columns: 1fr 1fr; /* Two columns for incomplete and complete items */
    }

    .incomplete-items,
    .complete-items {
        display: flex;
        flex-direction: column;
    }

    .completed-item {
        text-decoration: line-through;
    }
</style>

{% endblock %}